<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IDV Assignment 4 – Robustness Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f7;
      color: #222;
    }

    h1 {
      margin-bottom: 5px;
      font-size: 24px;
    }

    h2 {
      margin-top: 0;
      font-size: 15px;
      font-weight: normal;
      color: #555;
      max-width: 900px;
    }

    #chart-container {
      background: #fff;
      padding: 16px 24px 24px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
      max-width: 1100px;
    }

    .tooltip {
      position: absolute;
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      font-size: 12px;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
      z-index: 9999;
    }

    .axis text {
      font-size: 11px;
    }

    .legend text {
      font-size: 12px;
    }
  </style>

  <!-- D3 CDN -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>

  <div id="chart-container">
    <h1>Model Robust Accuracy under Different Attacks</h1>
    <h2>
      Each cell shows the accuracy (%) of a model under a specific adversarial attack.
      Darker color means higher accuracy.
    </h2>

    <div id="chart"></div>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <script>
    // ----------------------------
    // Embedded data_2.json
    // ----------------------------
    const rawData = {
      "No Attack": {
        "ERM": 94.85, "DA": 94.21, "PGDT": 84.38, "TRADES": 80.42,
        "MART": 81.54, "RS": 89.45, "IBP": 48.4, "PRL": 93.82, "TandT": 94.23
      },
      "TIFGSM": {
        "ERM": 35.1, "DA": 33.0, "PGDT": 65.7, "TRADES": 62.9,
        "MART": 69.1, "RS": 45.4, "IBP": 40.2, "PRL": 34.0, "TandT": 92.8
      },
      "MIFGSM": {
        "ERM": 0.0, "DA": 0.0, "PGDT": 50.9, "TRADES": 51.9,
        "MART": 50.5, "RS": 5.8, "IBP": 38.1, "PRL": 0.0, "TandT": 92.8
      },
      "DIFGSM": {
        "ERM": 1.0, "DA": 0.0, "PGDT": 51.75, "TRADES": 50.5,
        "MART": 53.6, "RS": 4.1, "IBP": 38.1, "PRL": 3.1, "TandT": 92.8
      },
      "VMIFGSM": {
        "ERM": 0.0, "DA": 0.0, "PGDT": 51.1, "TRADES": 50.9,
        "MART": 51.9, "RS": 4.1, "IBP": 38.1, "PRL": 0.0, "TandT": 93.9
      },
      "TPGD": {
        "ERM": 38.1, "DA": 39.2, "PGDT": 69.3, "TRADES": 69.1,
        "MART": 70.1, "RS": 48.5, "IBP": 50.0, "PRL": 28.9, "TandT": 91.8
      },
      "FGSM": {
        "ERM": 29.9, "DA": 25.8, "PGDT": 57.95, "TRADES": 54.6,
        "MART": 61.9, "RS": 28.9, "IBP": 38.1, "PRL": 25.8, "TandT": 93.8
      },
      "RFGSM": {
        "ERM": 0.0, "DA": 0.0, "PGDT": 49.15, "TRADES": 50.4,
        "MART": 48.5, "RS": 3.7, "IBP": 38.1, "PRL": 0.0, "TandT": 90.0
      },
      "BIM": {
        "ERM": 0.0, "DA": 0.0, "PGDT": 52.0, "TRADES": 57.2,
        "MART": 47.4, "RS": 2.1, "IBP": 38.1, "PRL": 0.0, "TandT": 90.7
      },
      "FAB": {
        "ERM": 1.0, "DA": 2.1, "PGDT": 43.0, "TRADES": 46.4,
        "MART": 40.2, "RS": 5.3, "IBP": 38.1, "PRL": 4.1, "TandT": 90.1
      },
      "CW": {
        "ERM": 0.0, "DA": 0.0, "PGDT": 32.2, "TRADES": 35.1,
        "MART": 29.9, "RS": 1.0, "IBP": 40.2, "PRL": 1.0, "TandT": 92.9
      }
      // 其余攻击方式也可以继续添加
    };

    // ----------------------------
    // Heatmap setup
    // ----------------------------
    const margin = { top: 60, right: 40, bottom: 90, left: 160 };
    const width = 900 - margin.left - margin.right;
    const height = 600 - margin.top - margin.bottom;

    const svg = d3.select("#chart")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const tooltip = d3.select("#tooltip");

    const attacks = Object.keys(rawData);
    const methods = Object.keys(rawData[attacks[0]]);

    const data = [];
    attacks.forEach(a => {
      methods.forEach(m => {
        data.push({
          attack: a,
          method: m,
          value: rawData[a][m]
        });
      });
    });

    const x = d3.scaleBand()
      .domain(methods)
      .range([0, width])
      .padding(0.05);

    const y = d3.scaleBand()
      .domain(attacks)
      .range([0, height])
      .padding(0.05);

    const color = d3.scaleSequential()
      .domain([0, 100])
      .interpolator(d3.interpolateBlues);

    // Axes
    svg.append("g")
      .attr("transform", `translate(0, ${height})`)
      .call(d3.axisBottom(x))
      .selectAll("text")
      .attr("transform", "rotate(-30)")
      .style("text-anchor", "end");

    svg.append("g").call(d3.axisLeft(y));

    svg.append("text")
      .attr("x", width / 2)
      .attr("y", -25)
      .attr("text-anchor", "middle")
      .style("font-size", "18px")
      .style("font-weight", "bold")
      .text("Robust Accuracy Heatmap");

    // Cells
    const cells = svg.selectAll("rect")
      .data(data)
      .enter()
      .append("rect")
      .attr("x", d => x(d.method))
      .attr("y", d => y(d.attack))
      .attr("width", x.bandwidth())
      .attr("height", y.bandwidth())
      .style("fill", d => color(d.value))
      .style("stroke", "#fff")
      .style("opacity", 0);

    // Transition animation
    cells
      .transition()
      .duration(800)
      .delay((d, i) => i * 5)
      .style("opacity", 1);

    // Tooltip interaction
    cells.on("mouseover", (event, d) => {
      d3.select(event.currentTarget).style("stroke", "#000");

      tooltip
        .style("opacity", 1)
        .html(
          `<strong>Attack:</strong> ${d.attack}<br>
           <strong>Model:</strong> ${d.method}<br>
           <strong>Accuracy:</strong> ${d.value.toFixed(2)}%`
        )
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 28) + "px");
    })
    .on("mousemove", event => {
      tooltip
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", event => {
      d3.select(event.currentTarget).style("stroke", "#fff");
      tooltip.style("opacity", 0);
    });

    // Legend
    const legendHeight = 180;
    const legendWidth = 14;

    const legendScale = d3.scaleLinear()
      .domain([0, 100])
      .range([legendHeight, 0]);

    const defs = svg.append("defs");
    const gradient = defs.append("linearGradient")
      .attr("id", "legend-gradient")
      .attr("x1", "0%")
      .attr("y1", "100%")
      .attr("x2", "0%")
      .attr("y2", "0%");

    d3.range(0, 1.01, 0.1).forEach(t => {
      gradient.append("stop")
        .attr("offset", `${t * 100}%`)
        .attr("stop-color", color(t * 100));
    });

    const legend = svg.append("g")
      .attr("transform", `translate(${width + 40}, ${height/2 - legendHeight/2})`);

    legend.append("rect")
      .attr("width", legendWidth)
      .attr("height", legendHeight)
      .style("fill", "url(#legend-gradient)");

    legend.append("g")
      .attr("transform", `translate(${legendWidth}, 0)`)
      .call(d3.axisRight(legendScale).ticks(5).tickFormat(d => d + "%"));

    legend.append("text")
      .attr("x", legendWidth / 2)
      .attr("y", -10)
      .attr("text-anchor", "middle")
      .style("font-size", "12px")
      .text("Accuracy");

  </script>
</body>
</html>
